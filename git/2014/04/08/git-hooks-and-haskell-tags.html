<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>git hooks and haskell tags</title>
        <meta name="viewport" content="width=device-width">

        <!-- syntax highlighting CSS -->
        <link rel="stylesheet" href="/css/syntax.css">

        <!-- Custom CSS -->
        <link rel="stylesheet" href="/css/main.css">

    </head>
    <body>

        <div class="site">
          <div class="header">
            <h1 class="title"><a href="/">Stuff Andrew Likes</a></h1>
            <a class="extra" href="/">home</a>
            <a class="extra" href="/categories.html">categories</a>
            <a class="extra" href="/tags.html">tags</a>
            <a class="extra" href="/archive.html">archive</a>
          </div>

          <h1>git hooks and haskell tags</h1>
<p class="meta">08 Apr 2014</p>

<div class="post">
<h1 id="git-hooks-and-tags">git hooks and tags</h1>
<p>I’ve been using Tim Pope’s <a href="http://tbaggery.com/2011/08/08/effortless-ctags-with-git.html">effortless ctags with git</a> blog post to keep my tags file up to date. The gist of it is to keep your tags file in <code>.git/tags</code> (if you have the excellent <a href="https://github.com/tpope/vim-fugitive">vim-fugitive</a> installed vim is configured to look there) and update your tags file whenever the working tree changes. This comes in two parts: a script to update <code>.git/tags</code>, and hooks to call that script.</p>
<p>Following Tim Pope’s advice, and the advice of some of his commenters, I ended up with a script to update the tags that looked something like this:</p>
<div class="highlight"><pre><code class="bash"><span class="c">#! /bin/sh</span>

<span class="nv">GITDIR</span><span class="o">=</span><span class="k">$(</span>git rev-parse --git-dir<span class="k">)</span>
<span class="nv">TAGSFILE</span><span class="o">=</span>tags.<span class="nv">$$</span>

mkdir <span class="nv">$GITDIR</span>/tags_lock 2&gt;/dev/null <span class="o">||</span> <span class="nb">exit </span>0
<span class="nb">trap</span> <span class="s2">&quot;rmdir $GITDIR/tags_lock; rm $GITDIR/$TAGSFILE&quot;</span> EXIT

ctags --tag-relative -Rf <span class="nv">$GITDIR</span>/<span class="nv">$TAGSFILE</span> --exclude<span class="o">=</span><span class="nv">$GITDIR</span>

mv <span class="nv">$GITDIR</span>/<span class="nv">$TAGSFILE</span> <span class="nv">$GITDIR</span>/tags
</code></pre></div>


<p>This uses <a href="http://ctags.sourceforge.net/">exuberant ctags</a> to generate the tags file, and uses directory based locking<a href="#fn1" class="footnoteRef" id="fnref1"><sup>1</sup></a> so that a large rebase does not start tons of processes. <code>git rev-parse --git-dir</code> gets the git directory, and using it makes this work with submodules<a href="#fn2" class="footnoteRef" id="fnref2"><sup>2</sup></a>.</p>
<h1 id="generating-haskell-tags">generating haskell tags</h1>
<p>This works great for the <a href="http://ctags.sourceforge.net/languages.html">languages</a> that exuberant ctags supports, but unfortunately haskell is not one of those languages. This means we need to add in support for haskell tags.</p>
<p>The haskell wiki <a href="http://www.haskell.org/haskellwiki/Tags">lists</a> some possible solutions.</p>
<ul>
<li><a href="http://www.haskell.org/haskellwiki/GHC/GHCi">GHCi</a> can generate tags files. But to generate the tags, GHCi needs to know what language extensions to use and what modules to load. This information might be stored in a cabal file or a <code>.ghci</code> file, but we can’t rely on that.</li>
<li><a href="http://kingfisher.nfshost.com/sw/gasbag/">gasbag</a> does not understand all Haskell extensions, and cannot index haskell files that don’t compile.</li>
<li><a href="http://hackage.haskell.org/package/hothasktags">hothasktags</a> hothasktags needs to know language extensions (like GHCi), and cannot index haskell files that don’t compile (like gasbag).</li>
<li><a href="http://hackage.haskell.org/package/hasktags">hasktags</a> uses its own parser and therefore does not care about language extensions or valid Haskell. Hasktags does have some problems (see <a href="http://stackoverflow.com/questions/10058411/how-to-generate-tags-for-haskell-projects">this</a> stack overflow post), but I went with it.</li>
<li><a href="http://hackage.haskell.org/package/fast-tags">fast-tags</a> Fast-tags addresses some of the problems with hasktags in the above stack overflow post, but it’s under-documented and I have yet to run into hasktags’ issues anyway.</li>
</ul>
<h1 id="combining-hasktags-and-ctags">combining hasktags and ctags</h1>
<p>We could simply append the tags produced by hasktags to the tags from ctags, but vim expects tags files to be sorted (so it can <a href="http://en.wikipedia.org/wiki/Binary_search_algorithm">binary search</a> them). We must append then <a href="http://linux.die.net/man/1/sort">sort</a> (using <code>LC_COLLATE=C</code> as advised <a href="http://vim.wikia.com/wiki/Arbitrary_tags_for_file_names">here</a>).</p>
<div class="highlight"><pre><code class="bash"><span class="c"># exuberant ctags</span>
ctags --tag-relative -Rf <span class="nv">$GITDIR</span>/<span class="nv">$TAGSFILE</span> --exclude<span class="o">=</span><span class="nv">$GITDIR</span>

<span class="c"># hasktags</span>
<span class="k">if </span>which hasktags &gt; /dev/null <span class="p">;</span> <span class="k">then</span>
<span class="k">    </span><span class="nv">OLD_DIR</span><span class="o">=</span><span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span>
    <span class="o">(</span><span class="nb">cd</span> <span class="nv">$GITDIR</span> <span class="o">&amp;&amp;</span> hasktags -c -x --ignore-close-implementation -a -f <span class="nv">$TAGSFILE</span> <span class="nv">$OLD_DIR</span><span class="o">)</span>
    <span class="nv">LC_COLLATE</span><span class="o">=</span>C sort <span class="nv">$GITDIR</span>/<span class="nv">$TAGSFILE</span> -o <span class="nv">$GITDIR</span>/<span class="nv">$TAGSFILE</span>
<span class="k">fi</span>
</code></pre></div>


<p>Explanation of hasktags options:</p>
<ul>
<li><code>-c</code> means generate a vim (not emacs) format tags file,</li>
<li><code>-x</code> means generate additional information,</li>
<li><code>--ignore-close-implementation</code> avoids tagging both type signatures and implementations if the implementation is near the type signature.</li>
<li><code>-a</code> means append</li>
<li><code>-f</code> specifies output file</li>
</ul>
<p>Full script available as a <a href="https://gist.github.com/10231136">gist</a></p>
<section class="footnotes">
<hr />
<ol>
<li id="fn1"><p>Thanks <a href="http://tbaggery.com/2011/08/08/effortless-ctags-with-git.html#comment-728214764">Rich Healy</a>.<a href="#fnref1">↩</a></p></li>
<li id="fn2"><p>Thanks <a href="http://tbaggery.com/2011/08/08/effortless-ctags-with-git.html#comment-837431209">Paul</a>.<a href="#fnref2">↩</a></p></li>
</ol>
</section>

</div>

<div class="footer">

<h2>Categories</h2>
<ul>
    
    



    <li><a href="/categories.html#git-ref">
        git
    </a></li>




</ul>



<h2>Tags</h2>
<ul>
    
    


 
    <li><a href="/tags.html#git-ref">git</a></li>
 
    <li><a href="/tags.html#haskell-ref">haskell</a></li>
 
    <li><a href="/tags.html#vim-ref">vim</a></li>
 
    <li><a href="/tags.html#ctags-ref">ctags</a></li>




</ul>

</div>

<script type="text/javascript" src="https://c328740.ssl.cf1.rackcdn.com/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>


          <div class="footer">
            <div class="contact">
              <p>
                Andrew Noyes<br />
                Software Engineer<br />
                anoyes34@gmail.com
              </p>
            </div>
            <div class="contact">
              <p>
              <a href="https://github.com/atn34">github.com/atn34</a><br />
                <a href="https://twitter.com/atn34">twitter.com/atn34</a><br />
              </p>
            </div>
          </div>
        </div>

    </body>
</html>
